<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    <title>KTV ç³»çµ± (æ–°æ­Œæ“´å……ç‰ˆ)</title>
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        /* --- 1. åŸºç¤è¨­å®š (ç°ç™½æ¥µç°¡) --- */
        :root {
            --primary: #007bff; --bg-main: #f4f6f8; --bg-panel: #ffffff;
            --text-main: #333333; --text-sub: #666666; --border: #e0e0e0;
            --hover: #f1f3f5; --anim-speed: 0.5s;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif;
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
            background: var(--bg-main); color: var(--text-main);
        }

        /* è¼‰å…¥é®ç½© */
        #loadingMask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-main); color: var(--text-main); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s;
        }

        /* --- 2. é ‚éƒ¨å°èˆª --- */
        header {
            height: 55px; background: var(--bg-panel); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; flex-shrink: 0; z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        body.cinema-mode header { margin-top: -55px; }

        h1 { font-size: 1.2rem; margin: 0; color: var(--primary); font-weight: bold; }
        .btn { border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.9rem; transition: filter 0.2s; }
        .btn:hover { filter: brightness(0.9); }
        .btn-qr { background: #28a745; color: white; }
        .btn-cut { background: #dc3545; color: white; }
        .btn-pause { background: #ffc107; color: #333; }
        .header-controls { display: flex; gap: 8px; align-items: center; }

        /* --- 3. æ‡¸æµ®æ§åˆ¶ --- */
        .cinema-controls {
            position: fixed; top: 20px; right: 20px; z-index: 200; display: flex; gap: 10px;
            transform: translateY(-100px); transition: transform 0.3s ease;
        }
        body.cinema-mode .cinema-controls { transform: translateY(0); }
        .c-btn {
            padding: 10px 20px; border-radius: 30px; font-weight: bold; 
            border: 2px solid white; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); 
            font-size: 0.9rem; display: flex; align-items: center; justify-content: center;
        }
        .c-wake { background: rgba(0, 123, 255, 0.9); color: white; }
        .c-pause { background: rgba(255, 193, 7, 0.9); color: #333; display: none; }
        .c-cut { background: rgba(220, 53, 69, 0.9); color: white; display: none; }

        /* --- 4. ä½ˆå±€ --- */
        .main-layout { display: flex; flex: 1; height: calc(100vh - 55px); transition: height 0.5s ease; }
        body.cinema-mode .main-layout { height: 100vh; }

        .player-section {
            flex: 65; background: black; position: relative; 
            display: flex; flex-direction: column; justify-content: center;
            transition: all 0.5s ease;
        }
        body.cinema-mode .player-section { flex: 100; }
        body.remote-mode .player-section { display: none; }

        .video-wrapper { position: relative; width: 100%; height: 100%; }
        #playerAPI { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #otherFrame { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0; display:none; background: black; }

        #randomBadge {
            position: absolute; top: 20px; left: 20px; z-index: 20;
            background: rgba(255,255,255,0.9); color: #333; padding: 6px 15px;
            border-radius: 20px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: none; font-size: 0.9rem; pointer-events: none;
        }

        /* å¼·åˆ¶é€²åº¦æ¢ (è¦–è¦ºåŒ–è¨ˆæ™‚å™¨) */
        #forceProgressBar {
            position: absolute; bottom: 0; left: 0; height: 5px; background: var(--primary);
            width: 0%; z-index: 50; transition: width 1s linear; display: none;
        }

        .control-section {
            flex: 35; display: flex; flex-direction: column; 
            border-left: 1px solid var(--border); background: var(--bg-panel);
            min-width: 320px; transition: all 0.5s ease;
        }
        body.cinema-mode .control-section { flex: 0; min-width: 0; opacity: 0; overflow: hidden; }

        .search-bar { padding: 15px; border-bottom: 1px solid var(--border); background: var(--bg-panel); flex-shrink: 0;}
        .search-input { 
            width: 100%; padding: 10px 15px; border-radius: 20px; 
            border: 1px solid #ccc; font-size: 1rem; 
            background: #f8f9fa; color: var(--text-main); 
        }
        .search-input:focus { outline: none; border-color: var(--primary); background: white; }

        .tabs { display: flex; background: #e9ecef; flex-shrink: 0; }
        .tab { 
            flex: 1; padding: 12px; text-align: center; cursor: pointer; 
            border-bottom: 3px solid transparent; color: var(--text-sub); font-weight: bold;
        }
        .tab.active { 
            border-bottom: 3px solid var(--primary); color: var(--primary); 
            background: var(--bg-panel); 
        }
        
        .list-container { 
            flex: 1; overflow-y: auto; padding: 0; 
            padding-bottom: 80px; -webkit-overflow-scrolling: touch; 
            background: var(--bg-main);
        }

        .category-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 15px; }
        .cat-card {
            background: var(--bg-panel); border: 1px solid #ddd; 
            border-radius: 10px; height: 80px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }
        .cat-card:active { transform: scale(0.98); }
        .cat-card:hover { 
            background: var(--primary); color: white; border-color: var(--primary); 
            box-shadow: 0 4px 8px rgba(0,123,255,0.2);
        }
        .cat-name { font-size: 1.1rem; font-weight: bold; }
        
        .back-bar { 
            padding: 12px 15px; background: white; border-bottom: 1px solid #eee; 
            color: var(--primary); font-weight: bold; cursor: pointer; 
            display: flex; align-items: center; gap: 5px; flex-shrink: 0; 
        }
        .back-bar:hover { background: #f8f9fa; }

        .song-row { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px 15px; border-bottom: 1px solid #eee; 
            background: var(--bg-panel); cursor: pointer; 
        }
        .song-row:hover { background: var(--hover); }
        .song-info { display: flex; flex-direction: column; }
        .song-title { font-weight: bold; font-size: 1rem; color: var(--text-main); }
        .song-artist { font-size: 0.85rem; color: var(--text-sub); margin-top: 3px; }
        .btn-add { 
            background: var(--primary); color: white; border: none; 
            border-radius: 50%; width: 32px; height: 32px; font-size: 1.2rem; 
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        @media (max-width: 768px) {
            .main-layout { flex-direction: column; }
            .player-section { flex: none; height: 40vh; }
            body.cinema-mode .player-section { height: 100vh; }
            .control-section { flex: 1; height: 60vh; }
        }
        
        /* æ‰‹æ©Ÿé™æ§å™¨æ§åˆ¶åˆ— */
        .remote-ctrl-bar { 
            display: none; height: 65px; background: white; border-top: 1px solid #ccc; 
            flex-shrink: 0; z-index: 150; position: fixed; bottom: 0; left: 0; width: 100%;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        body.remote-mode .remote-ctrl-bar { display: flex; }
        .r-btn { flex: 1; border: none; font-size: 1.1rem; font-weight: bold; cursor: pointer; display: flex; justify-content: center; align-items: center;}
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 300; display: none; align-items: center; justify-content: center; }
        .modal-box { background: white; padding: 25px; border-radius: 15px; text-align: center; width: 85%; max-width: 320px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div id="loadingMask">
    <h2 style="color: var(--primary);">KTV ç³»çµ±è¼‰å…¥ä¸­...</h2>
</div>

<div class="cinema-controls">
    <button class="c-btn c-pause" id="cinemaPauseBtn" onclick="event.stopPropagation(); togglePlay()">â¯ æš«åœ/æ’­æ”¾</button>
    <button class="c-btn c-cut" id="cinemaCutBtn" onclick="event.stopPropagation(); playNext()">â­ åˆ‡æ­Œ</button>
    <button class="c-btn c-wake" onclick="wakeUp()">ğŸ¤ æˆ‘è¦é»æ­Œ</button>
</div>

<header>
    <h1 id="appTitle">ğŸ¤ KTV ç³»çµ±</h1>
    <div class="header-controls">
        <span id="nextSongHint" style="font-size:0.8rem; color: #666; margin-right:5px; display:none;">ç„¡å¾…æ’­</span>
        <button class="btn btn-pause" id="hostPauseBtn" onclick="togglePlay()" style="display:none;">â¯ æš«åœ/æ’­æ”¾</button>
        <button class="btn btn-cut" id="hostCutBtn" onclick="playNext()" style="display:none;">â­ åˆ‡æ­Œ</button>
        <button class="btn btn-qr" onclick="toggleModal(true)">ğŸ“± æ‰‹æ©Ÿ</button>
    </div>
</header>

<div class="main-layout" id="mainLayout">
    <div class="player-section" id="playerSection">
        <div class="video-wrapper">
            <div id="randomBadge">ğŸ² éš¨æ©Ÿæ’­æ”¾ä¸­...</div>
            <div id="forceProgressBar"></div> <div id="playerAPI"></div>
            <iframe id="otherFrame" allow="autoplay; fullscreen; encrypted-media; picture-in-picture; speaker; microphone"></iframe>
        </div>
    </div>

    <div class="control-section" id="controlSection">
        <div class="search-bar">
            <input type="text" class="search-input" placeholder="ğŸ” æ‰¾æ­Œæ‰‹ã€æ­Œå..." oninput="filterSongs(this.value)">
        </div>
        <div class="tabs">
            <div class="tab active" onclick="switchTab('songs')">æ­Œæ›²åº«</div>
            <div class="tab" onclick="switchTab('queue')">å·²é» (<span id="queueBadge">0</span>)</div>
        </div>
        <div class="list-container" id="listContainer"></div>
    </div>
</div>

<div class="remote-ctrl-bar">
    <button class="r-btn" style="background:#ffc107; color:#333;" onclick="sendCmd('pause')">â¯ æš«åœ/æ’­æ”¾</button>
    <button class="r-btn" style="background:#dc3545; color:white;" onclick="sendCmd('next')">â­ åˆ‡æ­Œ</button>
</div>

<div class="modal-overlay" id="qrModal" onclick="toggleModal(false)">
    <div class="modal-box" onclick="event.stopPropagation()">
        <h3 style="color: var(--text-main);">ğŸ“± æ‰‹æ©Ÿè®Šæˆé™æ§å™¨</h3>
        <p style="color:#666; font-size:0.9rem; margin-bottom:15px;">æƒæå¾Œï¼Œæœ‹å‹ä¹Ÿèƒ½ä¸€èµ·æ§åˆ¶ï¼</p>
        <img id="qrImg" style="width:200px; height:200px; background:#eee; border-radius:8px;">
        <button class="btn" onclick="toggleModal(false)" style="margin-top:15px; background:#666; color:white;">é—œé–‰</button>
    </div>
</div>

<script>
    // --- 1. è³‡æ–™åº« (Duration å–®ä½: ç§’) ---
    // å·²åŠ å…¥æ‚¨æä¾›çš„æ–°æ­Œå–®
    let allSongs = [
        { id: 'fWNaR-rxAic', platform: 'youtube', title: 'Call Me Maybe', artist: 'Carly Rae Jepsen', tags: ['english', 'female'], duration: 193 },
        { id: '@uangluoktv:9/baby:86', platform: 'odysee', title: 'Baby', artist: 'Justin Bieber ft. Ludacris', tags: ['english','duet'], duration: 220 },
        { id: 'qu_FSptjRic', platform: 'youtube', title: 'æµ·é—Šå¤©ç©º', artist: 'Beyond', tags: ['cantonese', 'group', 'male'], duration: 324 },
        { id: 'SX_ViT4Ra7k', platform: 'youtube', title: 'Lemon', artist: 'ç±³æ´¥ç„å¸«', tags: ['japanese', 'male'], duration: 255 },
        { id: '@uangluoktv:9/jiuerling:4', platform: 'odysee', title: '920', artist: 'A-Lin ft. å°å®‡', tags: ['mandarin', 'duet'], duration: 288 },
        { id: '@uangluoktv:9/zhenmele:7', platform: 'odysee', title: 'æ€éº¼äº†', artist: 'å‘¨èˆˆå“²', tags: ['mandarin', 'male'], duration: 320 },
        { id: '_3jyg3khFwM', platform: 'youtube', title: 'å‘Šç™½æ°£çƒ', artist: 'å‘¨æ°å€«', tags: ['mandarin', 'male'], duration: 215 },
        { id: 'sF2d9RzBv2g', platform: 'youtube', title: 'æƒ³å’Œä½ çœ‹äº”æœˆçš„æ™šéœ', artist: 'é™³è¯', tags: ['mandarin', 'female'], duration: 242 },
        { id: 'BV1St4meVEqF', platform: 'bilibili', title: 'å¦‚æœå¯ä»¥ï¼ˆä¸­æ–‡ç‰ˆï¼‰', artist: 'éŸ‹ç¦®å®‰', tags: ['mandarin', 'male'], duration: 260 },
        { id: 'BV1yaUiYqEbx', platform: 'bilibili', title: 'æµªå­å›é ­', artist: 'èŒ„å­è›‹', tags: ['hokkien', 'group', 'male'], duration: 290 },
        { id: 'KzQYv4J3oI8', platform: 'youtube', title: 'å®¶å¾Œ', artist: 'æ±Ÿè•™', tags: ['hokkien', 'female'], duration: 270 },
        { id: 'BV1dJNdzyEw5', platform: 'bilibili', title: 'æ„›æƒ…ä½ æ¯”æˆ‘æƒ³çš„é–£è¼ƒå‰å¤§', artist: 'èŒ„å­è›‹', tags: ['hokkien', 'group', 'male'], duration: 230 },
        { id: 'BV1ex411R7Br', platform: 'bilibili', title: 'Gangnam Style', artist: 'PSY', tags: ['korean', 'male'], duration: 220 },
        { id: 'ZdSzHzC-e44', platform: 'youtube', title: 'Dynamite', artist: 'BTS', tags: ['korean', 'group', 'male'], duration: 200 },
        { id: 'Mq28V9wzw00', platform: 'youtube', title: 'Super Shy', artist: 'NewJeans', tags: ['korean', 'group', 'female'], duration: 160 },
        { id: 'vjRiJtF9WFg', platform: 'youtube', title: 'å€’å¸¶', artist: 'è”¡ä¾æ—', tags: ['mandarin', 'female'], duration: 265 },
        { id: '@uangluoktv:9/taeyeoni:b', platform: 'odysee', title: 'I', artist: 'æ³°å¦', tags: ['korean', 'female'], duration: 240 },
        { id: '@uangluoktv:9/zaiyueshilibaojinwo:b', platform: 'odysee', title: 'åœ¨æœˆè•è£¡æŠ±ç·Šæˆ‘', artist: 'æ—ä¿Šå‚‘ ft. A-Lin', tags: ['mandarin', 'duet'], duration: 250 },
        { id: '@uangluoktv:9/zaijianagongheguolihun:5', platform: 'odysee', title: 'åœ¨è¿¦ç´å…±å’Œåœ‹é›¢å©š', artist: 'è²é“çˆ¾ ft. å¤§ç©', tags: ['mandarin', 'duet'], duration: 260 },
        { id: '@uangluoktv:9/xuanni:1', platform: 'odysee', title: 'æ‡¸æºº', artist: 'è‘›æ±çª', tags: ['mandarin', 'male'], duration: 200 },
        { id: '@uangluoktv:9/tiaolouji:b', platform: 'odysee', title: 'è·³æ¨“æ©Ÿ', artist: 'åˆ©æ¯”', tags: ['mandarin', 'male'], duration: 210 },
        { id: '@uangluoktv:9/xiaochengxiatian:d', platform: 'odysee', title: 'å°åŸå¤å¤©', artist: 'åˆ©æ¯”', tags: ['mandarin', 'male'], duration: 180 },
        { id: '@uangluoktv:9/duoyuandouyaozaiyiqi:1', platform: 'odysee', title: 'å¤šé éƒ½è¦åœ¨ä¸€èµ·', artist: 'é„§ç´«æ£‹', tags: ['mandarin', 'female'], duration: 225 },
        { id: '@uangluoktv:9/tiankongmeiyoujixian:4', platform: 'odysee', title: 'å¤©ç©ºæ²’æœ‰æ¥µé™', artist: 'é„§ç´«æ£‹', tags: ['mandarin', 'female'], duration: 230 },
        { id: '@uangluoktv:9/solo:ef', platform: 'odysee', title: 'Solo', artist: 'Jennie', tags: ['korean', 'female'], duration: 170 }, 
        { id: '@uangluoktv:9/yanshilidehua:5', platform: 'odysee', title: 'å²©çŸ³è£¡çš„èŠ±', artist: 'é„§ç´«æ£‹', tags: ['mandarin', 'female'], duration: 215 },
        { id: '@uangluoktv:9/xihuanni:1', platform: 'odysee', title: 'å–œæ­¡ä½ ', artist: 'é„§ç´«æ£‹', tags: ['cantonese', 'female'], duration: 235 },
        { id: '@uangluoktv:9/wanjia:7', platform: 'odysee', title: 'ç©å®¶', artist: 'æ›¹æ¥Š ft. æ´¾å‰ä¿Š', tags: ['mandarin', 'duet'], duration: 200 },
        { id: '@uangluoktv:9/qiyue:d', platform: 'odysee', title: 'ä¸ƒæœˆ', artist: 'æ›¹æ¥Š', tags: ['mandarin', 'male'], duration: 220 },
        { id: '@uangluoktv:9/jiangnan:d', platform: 'odysee', title: 'æ±Ÿå—ï¼ˆç²µèªç‰ˆï¼‰', artist: 'æ—ä¿Šå‚‘', tags: ['cantonese', 'male'], duration: 260 },
        { id: '@uangluoktv:9/zuiaidetong:2', platform: 'odysee', title: 'æœ€æ„›çš„ç—›', artist: 'æ¢å¿ƒé ¤', tags: ['mandarin', 'female'], duration: 240 },
        { id: '@uangluoktv:9/weiduoliyademimi:4', platform: 'odysee', title: 'è–‡å¤šè‰äºçš„ç§˜å¯†', artist: 'å¼µæƒ å¦¹', tags: ['mandarin', 'female'], duration: 210 },
        { id: '@uangluoktv:9/jianao:1', platform: 'odysee', title: 'ç…ç†¬', artist: 'æä½³è–‡', tags: ['mandarin', 'female'], duration: 280 },
        { id: '@uangluoktv:9/kamen:3', platform: 'odysee', title: 'å¡é–€', artist: 'å¼µæƒ å¦¹', tags: ['mandarin', 'female'], duration: 230 },
        { id: '@uangluoktv:9/weijiaxingfu:0', platform: 'odysee', title: 'å¾®åŠ å¹¸ç¦', artist: 'éƒå¯å”¯', tags: ['mandarin', 'female'], duration: 250 },
        { id: '@uangluoktv:9/buzuibuhui:e', platform: 'odysee', title: 'ä¸é†‰ä¸æœƒ', artist: 'ç”°é¦¥ç”„', tags: ['mandarin', 'female'], duration: 220 },
        { id: '@uangluoktv:9/bufang:c', platform: 'odysee', title: 'ä¸æ”¾', artist: 'å‘¨æ¹¯è±ª', tags: ['mandarin', 'male'], duration: 210 },
        { id: '@uangluoktv:9/zaimeiyouniyihou:e', platform: 'odysee', title: 'åœ¨æ²’æœ‰ä½ ä»¥å¾Œ', artist: 'è¬å’Œå¼¦ ft. å¼µæ™ºæˆ', tags: ['mandarin', 'duet'], duration: 260 },
        { id: '@uangluoktv:9/bijingshenaiguo:3', platform: 'odysee', title: 'ç•¢ç«Ÿæ·±æ„›é', artist: 'å…­å“²', tags: ['mandarin', 'male'], duration: 230 },
        { id: '@uangluoktv:9/wohuideng:d', platform: 'odysee', title: 'æˆ‘æœƒç­‰', artist: 'æ‰¿æ¡“', tags: ['mandarin', 'male'], duration: 245 },
        { id: '@uangluoktv:9/likaideyilushang:4', platform: 'odysee', title: 'é›¢é–‹çš„ä¸€è·¯ä¸Š', artist: 'ç†æƒ³æ··è›‹', tags: ['mandarin', 'group', 'male'], duration: 270 },
        { id: '@uangluoktv:9/zuihouyimiaozhong:2', platform: 'odysee', title: 'æœ€å¾Œä¸€ç§’é˜', artist: 'é‚±é‹’æ¾¤ ft. é™³é›¶ä¹', tags: ['mandarin', 'duet'], duration: 220 },
        { id: '@uangluoktv:9/yubutingliu:6', platform: 'odysee', title: 'é›¨ä¸åœã€‚æµ', artist: 'å­«ç››å¸Œ', tags: ['mandarin', 'female'], duration: 240 },
        { id: '@uangluoktv:9/iam:5', platform: 'odysee', title: 'I Am', artist: 'IVE', tags: ['korean', 'group', 'female'], duration: 185 },
        { id: '@uangluoktv:9/seven:65', platform: 'odysee', title: 'Seven', artist: 'æŸ¾åœ‹ ft. Latto', tags: ['korean', 'duet'], duration: 180 },
        { id: '@uangluoktv:9/rihuanshi:b', platform: 'odysee', title: 'æ—¥ç’°é£Ÿ', artist: 'é‚±é‹’æ¾¤', tags: ['mandarin', 'male'], duration: 230 },
        { id: '@uangluoktv:9/shuenjiandeshuenjian:6', platform: 'odysee', title: 'ç¬é–“çš„ç¬é–“', artist: 'æ—ä¿Šå‚‘', tags: ['mandarin', 'male'], duration: 240 },
        { id: '@uangluoktv:9/laidebengbeng:0', platform: 'odysee', title: 'ä¾†å€‹è¹¦è¹¦', artist: 'ç–å£¹å£¹ ft. é™³å˜‰æ¨º', tags: ['mandarin', 'duet'], duration: 200 },
        { id: '@uangluoktv:9/duanxun:c', platform: 'odysee', title: 'æ–·è¨Š', artist: 'é‚±é‹’æ¾¤ ft. é»ƒå‰æ™‰', tags: ['mandarin', 'duet'], duration: 250 },
        { id: '@uangluoktv:9/mazigou:7', platform: 'odysee', title: 'é¦¬å­ç‹—', artist: 'å…«ä¸‰å¤­ ft. ç–å£¹å£¹', tags: ['mandarin', 'duet'], duration: 215 },
        { id: '@uangluoktv:9/sushiaiqing:f', platform: 'odysee', title: 'é€Ÿé£Ÿæ„›æƒ…', artist: 'å››å …æƒ…', tags: ['mandarin', 'group', 'fmale'], duration: 205 },
        { id: '@uangluoktv:9/dongmian:7', platform: 'odysee', title: 'å†¬çœ ', artist: 'å¸å—', tags: ['mandarin', 'female'], duration: 230 },
        { id: '@uangluoktv:9/shenqibaima:2', platform: 'odysee', title: 'èº«é¨ç™½é¦¬', artist: 'å¾ä½³ç‘©', tags: ['mandarin', 'female'], duration: 250 },
        { id: '@uangluoktv:9/wodexinyi:6', platform: 'odysee', title: 'æˆ‘çš„æ–°è¡£', artist: 'VAVA ft. featuring Ty. & ç‹å€©å€©', tags: ['mandarin', 'duet'], duration: 220 },
        { id: '@uangluoktv:9/babyboy:f', platform: 'odysee', title: 'BABY BOY', artist: 'ç‹å¿ƒå‡Œ', tags: ['mandarin', 'female'], duration: 200 },
        { id: '@uangluoktv:9/shizaibixing:0', platform: 'odysee', title: 'å‹¢åœ¨å¿…è¡Œ', artist: 'ç•¢æ›¸ç›¡ ft. é™³å‹¢å®‰', tags: ['mandarin', 'duet'], duration: 240 },
        { id: '@uangluoktv:9/zuixuanmingzufeng:8', platform: 'odysee', title: 'æœ€ç‚«æ°‘æ—é¢¨', artist: 'é³³å‡°å‚³å¥‡', tags: ['mandarin', 'group', 'duet'], duration: 260 },
        { id: '@uangluoktv:9/tianheiqingbiyan:8', platform: 'odysee', title: 'å¤©é»‘è«‹é–‰çœ¼', artist: 'é‚±é‹’æ¾¤ ft. é™³é›¶ä¹', tags: ['mandarin', 'duet'], duration: 255 },
        { id: '@uangluoktv:9/tianliangqingzhengyan:f', platform: 'odysee', title: 'å¤©äº®è«‹çœçœ¼', artist: 'é‚±é‹’æ¾¤ ft. é™³é›¶ä¹', tags: ['mandarin', 'duet'], duration: 245 },
        { id: '@uangluoktv:9/chuenni:6', platform: 'odysee', title: 'æ˜¥æ³¥', artist: 'åº¾æ¾„æ…¶', tags: ['mandarin', 'male'], duration: 270 },
        { id: '@uangluoktv:9/meitianduoainiyixie:2', platform: 'odysee', title: 'æ¯å¤©å¤šæ„›ä½ å¤šä¸€äº›', artist: 'å¼µå­¸å‹', tags: ['cantonese', 'male'], duration: 280 },
        { id: '@uangluoktv:9/xiangjiannixiangjiannixiangjianni:a', platform: 'odysee', title: 'æƒ³è¦‹ä½ æƒ³è¦‹ä½ æƒ³è¦‹ä½ ï¼ˆä¸­æ–‡ç‰ˆï¼‰', artist: 'å…«ä¸‰å¤­', tags: ['mandarin', 'group', 'fmale'], duration: 240 },
        { id: '@uangluoktv:9/xiangjiannixiangjiannixiangjianniyueyu:7', platform: 'odysee', title: 'æƒ³è¦‹ä½ æƒ³è¦‹ä½ æƒ³è¦‹ä½ ï¼ˆç²µèªç‰ˆï¼‰', artist: 'å…«ä¸‰å¤­', tags: ['cantonese', 'group', 'fmale'], duration: 240 },
        { id: '@uangluoktv:9/niyaodequannazou:8', platform: 'odysee', title: 'ä½ è¦çš„å…¨æ‹¿èµ°', artist: 'èƒ¡å½¥æ–Œ', tags: ['mandarin', 'male'], duration: 260 },
        { id: '@uangluoktv:9/kele:7', platform: 'odysee', title: 'æ¸´äº†', artist: 'å¼µæƒ å¦¹', tags: ['mandarin', 'female'], duration: 215 },
        { id: '@uangluoktv:9/sanxingliangyi:a', platform: 'odysee', title: 'ä¸‰å¿ƒå…©æ„', artist: 'é»ƒæ–‡æ˜Ÿ ft. æ›¾æ˜±å˜‰', tags: ['hokkien', 'duet'], duration: 230 },
        { id: '@uangluoktv:9/electricheart:5', platform: 'odysee', title: 'Electric Heart', artist: '8TURN', tags: ['korean', 'group', 'male'], duration: 200 },
        { id: '@uangluoktv:9/tonghua:a', platform: 'odysee', title: 'ç«¥è©±', artist: 'å…‰è‰¯', tags: ['mandarin', 'male'], duration: 245 },
        { id: '@uangluoktv:9/guaimeide:3', platform: 'odysee', title: 'æ€ªç¾çš„', artist: 'è”¡ä¾æ—', tags: ['mandarin', 'female'], duration: 230 },
        { id: '@uangluoktv:9/meichuxi:a', platform: 'odysee', title: 'æ²’å‡ºæ¯', artist: 'ç‹ä¸–å … ft. ç‹æ', tags: ['mandarin', 'duet'], duration: 210 },
        { id: '@uangluoktv:9/pitsun:a', platform: 'odysee', title: 'å¿…å·¡', artist: 'æ›¾ç‘‹ä¸­', tags: ['hokkien', 'male'], duration: 240 },
        { id: '@uangluoktv:9/womendeai:f', platform: 'odysee', title: 'æˆ‘å€‘çš„æ„›', artist: 'é£›å…’æ¨‚åœ˜', tags: ['mandarin', 'group', 'female'], duration: 260 },
        { id: '@uangluoktv:9/shengshengman:a', platform: 'odysee', title: 'è²è²æ…¢', artist: 'é„§ç¦å¦‚', tags: ['mandarin', 'female'], duration: 220 },
        { id: '@uangluoktv:9/meirenyu:8', platform: 'odysee', title: 'ç¾äººé­š', artist: 'æ—ä¿Šå‚‘', tags: ['mandarin', 'male'], duration: 250 },
        { id: '@uangluoktv:9/zhiyou:d', platform: 'odysee', title: 'æ‘¯å‹', artist: 'A-Lin', tags: ['mandarin', 'female'], duration: 270 },
        { id: '@uangluoktv:9/mengxingshifen:8', platform: 'odysee', title: 'å¤¢é†’æ™‚åˆ†', artist: 'é™³æ·‘æ¨º', tags: ['mandarin', 'female'], duration: 245 },
        { id: '@uangluoktv:9/xiexingaiqingqushi:a', platform: 'odysee', title: 'è¡€è…¥æ„›æƒ…æ•…äº‹', artist: 'é˜¿å¯†ç‰¹ï¼ˆå¼µæƒ å¦¹ï¼‰', tags: ['mandarin', 'female'], duration: 255 },
        { id: '@uangluoktv:9/xuanze:4', platform: 'odysee', title: 'é¸æ“‡', artist: 'æ—å­ç¥¥ ft. è‘‰è’¨æ–‡', tags: ['mandarin', 'duet'], duration: 280 },
        { id: '@uangluoktv:9/qingfeideyi:e', platform: 'odysee', title: 'æƒ…éå¾—å·²', artist: 'åº¾æ¾„æ…¶', tags: ['mandarin', 'male'], duration: 265 },
        { id: '@uangluoktv:9/ruguokeyizhongwen:9', platform: 'odysee', title: 'å¦‚æœå¯ä»¥ï¼ˆä¸­æ–‡ç‰ˆï¼‰', artist: 'éŸ‹ç¦®å®‰', tags: ['mandarin', 'male'], duration: 260 },
        { id: '@uangluoktv:9/wotaiben:d', platform: 'odysee', title: 'æˆ‘å¤ªç¬¨', artist: 'éŒ˜å¨œéº—è', tags: ['mandarin', 'female'], duration: 235 },
        { id: 'BV12F8ieyEj4', platform: 'bilibili', title: 'Really Like You', artist: 'GYUBIN', tags: ['korean', 'female'], duration: 240 },
        { id: 'BV1wSxueQErg', platform: 'bilibili', title: 'DINOSAUR', artist: 'æ¨‚ç«¥', tags: ['korean', 'group'], duration: 240 },
        { id: 'BV1FM4m1y7bV', platform: 'bilibili', title: 'CROWN', artist: 'TOMORROW X TOGETHER', tags: ['korean', 'group'], duration: 240 },
        { id: 'BV1o4KWePE3M', platform: 'bilibili', title: 'Sugar Rush Rideï¼ˆéŸ“èªç‰ˆï¼‰', artist: 'TOMORROW X TOGETHER', tags: ['korean', 'group'], duration: 240 },
        { id: 'BV17FKFevEs4', platform: 'bilibili', title: 'Sugar Rush Rideï¼ˆå¤é¢¨ç‰ˆï¼‰', artist: 'TOMORROW X TOGETHER', tags: ['korean', 'group'], duration: 240 },
        { id: 'BV1p2E7zSEYu', platform: 'bilibili', title: 'When the Day Comes', artist: 'HI-BOYZ', tags: ['korean', 'group'], duration: 240 },
        { id: 'BV1bwgSzhERS', platform: 'bilibili', title: 'Heaven', artist: 'TOMORROW X TOGETHER', tags: ['korean', 'group'], duration: 240 },
        { id: 'BV1QTmWYGEns', platform: 'bilibili', title: 'Boyfriend', artist: 'å´”ç„¶ç«£', tags: ['korean', 'male'], duration: 240 },
        { id: 'BV1QTmWYGEns', platform: 'bilibili', title: 'No Doubt', artist: 'ENHYPEN', tags: ['korean', 'group'], duration: 240 },
        { id: 'BV1PJ4m1P7Yf', platform: 'bilibili', title: 'Sweet Venomï¼ˆéŸ“èªç‰ˆï¼‰', artist: 'ENHYPEN', tags: ['korean', 'group'], duration: 240 },
        { id: 'BV16uSiBdEys', platform: 'bilibili', title: 'Sweet Venomï¼ˆæ··éŸ³ç‰ˆï¼‰', artist: 'ENHYPEN', tags: ['korean', 'group'], duration: 240 },
        { id: 'BV1qG6aYxE3s', platform: 'bilibili', title: 'Polaroid Love', artist: 'ENHYPEN', tags: ['korean', 'group'], duration: 240 },
        { id: 'BV1dvPVecEAf', platform: 'bilibili', title: 'Go Big or Go Home', artist: 'ENHYPEN', tags: ['korean', 'group'], duration: 240 },
        { id: 'BV17qSqB4E8i', platform: 'bilibili', title: 'Blockbusterï¼ˆì•¡ì…˜ ì˜í™”ì²˜ëŸ¼ï¼‰', artist: 'ENHYPEN ft. å´”ç„¶ç«£', tags: ['korean', 'duet'], duration: 240 },
        { id: 'BV1tXCDBwE26', platform: 'bilibili', title: 'Body', artist: 'å¤šæ¦®', tags: ['korean', 'female'], duration: 240 },
        { id: 'BV1yuCcB7EnM', platform: 'bilibili', title: 'Live My Life', artist: 'aespa', tags: ['korean', 'group'], duration: 240 },
        { id: 'BV1hBfdYhEi4', platform: 'bilibili', title: 'Rebel Heart', artist: 'IVE', tags: ['korean', 'group'], duration: 240 },
        { id: 'BV1KTSnYYEe9', platform: 'bilibili', title: 'Whiplash', artist: 'aespa', tags: ['korean', 'group'], duration: 240 },
        { id: 'BV1ZQ8MzyE5p', platform: 'bilibili', title: 'Golden', artist: 'HUNTR/X', tags: ['korean', 'group'], duration: 240 },
        { id: 'BV1b18tznEi7', platform: 'bilibili', title: 'Soda Pop', artist: 'Saja Boys', tags: ['korean', 'group'], duration: 240 },
        { id: 'BV1ZWmMYLEFp', platform: 'bilibili', title: 'Queencard', artist: '(G)I-DLE', tags: ['korean', 'group'], duration: 240 },
        { id: 'BV1x34y1t7ms', platform: 'bilibili', title: 'TOMBOY', artist: '(G)I-DLE', tags: ['korean', 'group'], duration: 240 },
        { id: 'BV1gnJbzcEhK', platform: 'bilibili', title: 'Good Thing', artist: 'i-dle', tags: ['korean', 'group'], duration: 240 },
        { id: 'BV1if4feQEEw', platform: 'bilibili', title: 'Run Away', artist: 'å‘¨å­ç‘œ', tags: ['korean', 'female'], duration: 240 },
        { id: '52LeZX1HDiI', platform: 'youtube', title: 'I Got A Boy', artist: 'å°‘å¥³æ™‚ä»£', tags: ['korean', 'group'], duration: 240 }
    ];

    const categories = [
        { id: 'mandarin', name: 'è¯èªé‡‘æ›²' }, { id: 'hokkien', name: 'è‡ºèªç¶“å…¸' },
        { id: 'korean', name: 'éŸ“èªæµè¡Œ' }, { id: 'english', name: 'è‹±èªå›å‘³' },
        { id: 'cantonese', name: 'ç²µèªå‹•è½' }, { id: 'japanese', name: 'æ—¥èªç²¾é¸' },
        { id: 'duet', name: 'é›™äººåˆå”±' }, { id: 'male', name: 'ç”·æ­Œæ‰‹' }, 
        { id: 'female', name: 'å¥³æ­Œæ‰‹' }, { id: 'group', name: 'æ¨‚åœ˜/åœ˜é«”' }
    ];

    // --- ç‹€æ…‹ ---
    let queue = [];
    let currentMode = 'songs';
    let currentCategory = null; 
    let isPlaying = false;
    let isPaused = false; 
    let isRandomPlaying = false;
    let ytPlayer = null; 
    let currentPlatform = 'none';
    let searchTerm = '';
    let currentSongTimer = null; 

    const isClient = !!new URLSearchParams(location.search).get('host');
    let idleTimer;
    const IDLE_LIMIT = 30000; 

    // --- åˆå§‹åŒ– ---
    window.onload = () => {
        setTimeout(() => {
            document.getElementById('loadingMask').style.opacity = '0';
            setTimeout(() => document.getElementById('loadingMask').style.display = 'none', 500);
        }, 1000);

        if(isClient) {
            document.body.classList.add('remote-mode');
            document.getElementById('appTitle').innerText = "ğŸ“± KTV é™æ§å™¨";
            document.querySelector('.btn-qr').style.display = 'none';
            initClient(new URLSearchParams(location.search).get('host'));
        } else {
            initHost();
            setTimeout(checkAutoPlay, 2000); 
        }
        renderMainView();
        resetTimer();
    };

    // --- YouTube API ---
    function onYouTubeIframeAPIReady() { console.log("YT API Ready"); }
    function createYTPlayer(videoId) {
        if (ytPlayer) { ytPlayer.loadVideoById(videoId); return; }
        ytPlayer = new YT.Player('playerAPI', {
            height: '100%', width: '100%', videoId: videoId,
            playerVars: { 
                'autoplay': 1, 'controls': 1, 'rel': 0, 'playsinline': 1, 
                'iv_load_policy': 3, 'origin': window.location.origin 
            },
            events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange, 'onError': onPlayerError }
        });
    }
    
    function onPlayerReady(event) { 
        event.target.unMute(); event.target.setVolume(100); event.target.playVideo(); 
    }
    
    function onPlayerStateChange(event) { 
        if (event.data === YT.PlayerState.ENDED) { playNext(); }
    }
    function onPlayerError(event) { console.log("YT Error", event); playNext(); }

    // --- æ’­æ”¾æ§åˆ¶ ---
    function togglePlay() {
        if(isClient) { 
            sendCmd('pause'); 
            return; 
        }

        console.log("åŸ·è¡Œæš«åœ/æ’­æ”¾, å¹³å°:", currentPlatform);

        if (currentPlatform === 'youtube') {
            if (ytPlayer && typeof ytPlayer.getPlayerState === 'function') {
                const state = ytPlayer.getPlayerState();
                if (state === 1) { 
                    ytPlayer.pauseVideo();
                    isPaused = true;
                } else { 
                    ytPlayer.playVideo();
                    isPaused = false;
                }
            }
        } else {
            // [Odysee/Bilibili æš«åœä¿®å¾©] å˜—è©¦ç™¼é€ postMessage
            const iframe = document.getElementById('otherFrame');
            if(iframe && iframe.contentWindow) {
                const action = isPaused ? 'play' : 'pause';
                iframe.contentWindow.postMessage(JSON.stringify({ method: action }), "*");
                const ytAction = isPaused ? 'playVideo' : 'pauseVideo';
                iframe.contentWindow.postMessage(JSON.stringify({ "event": "command", "func": ytAction, "args": [] }), "*");
                isPaused = !isPaused;
            }
        }
        resetTimer();
    }

    function playVideo(song) {
        if(isClient) return;
        
        if(currentSongTimer) clearTimeout(currentSongTimer);
        stopProgress();

        isPlaying = true;
        isPaused = false;
        currentPlatform = song.platform;
        
        toggleControls(true);
        document.getElementById('randomBadge').style.display = isRandomPlaying ? 'block' : 'none';

        const otherFrame = document.getElementById('otherFrame');
        if (song.platform === 'youtube') {
            otherFrame.style.display = 'none'; otherFrame.src = "";
            if (!document.getElementById('playerAPI')) {
                const newDiv = document.createElement('div'); newDiv.id = 'playerAPI';
                document.querySelector('.video-wrapper').insertBefore(newDiv, otherFrame);
                ytPlayer = null;
            }
            createYTPlayer(song.id);
        } else {
            if(ytPlayer) { ytPlayer.stopVideo(); }
            const ytIframe = document.querySelector('.video-wrapper iframe:not(#otherFrame)');
            if(ytIframe) ytIframe.style.display = 'none';
            
            otherFrame.style.display = 'block';
            
            if (song.platform === 'bilibili') otherFrame.src = `//player.bilibili.com/player.html?bvid=${song.id}&page=1&high_quality=1&danmaku=0&autoplay=1`;
            else if (song.platform === 'odysee') otherFrame.src = `https://odysee.com/$/embed/${song.id}?autoplay=true&muted=false`;

            const duration = song.duration || 240; 
            currentSongTimer = setTimeout(playNext, duration * 1000);
            startProgress(duration);
        }
        broadcastStatus();
    }

    function startProgress(duration) {
        const bar = document.getElementById('forceProgressBar');
        bar.style.display = 'block';
        bar.style.width = '0%';
        bar.style.transition = `width ${duration}s linear`;
        void bar.offsetWidth; 
        bar.style.width = '100%';
    }

    function stopProgress() {
        const bar = document.getElementById('forceProgressBar');
        bar.style.transition = 'none';
        bar.style.width = '0%';
        bar.style.display = 'none';
    }

    function playNext() {
        if(currentSongTimer) clearTimeout(currentSongTimer);
        stopProgress();
        
        if (queue.length > 0) { 
            isRandomPlaying = false; 
            playVideo(queue.shift()); 
            updateStatus(); 
        } else { 
            playRandomSong(); 
        }
        broadcastStatus();
    }

    function playRandomSong() {
        isRandomPlaying = true;
        playVideo(allSongs[Math.floor(Math.random() * allSongs.length)]);
    }

    function checkAutoPlay() { if (!isPlaying && queue.length === 0) playRandomSong(); }

    function addSong(song) {
        if (!isPlaying || isRandomPlaying) { isRandomPlaying = false; playVideo(song); }
        else { queue.push(song); updateStatus(); }
        wakeUp(); broadcastStatus();
    }

    function removeSong(idx) { queue.splice(idx, 1); updateStatus(); broadcastStatus(); }

    // --- ä»‹é¢é‚è¼¯ ---
    function switchTab(mode) {
        currentMode = mode;
        if(mode === 'songs') { currentCategory = null; searchTerm = ''; document.querySelector('.search-input').value = ''; }
        document.querySelectorAll('.tab').forEach((el, idx) => el.classList.toggle('active', (mode === 'songs' && idx === 0) || (mode === 'queue' && idx === 1)));
        renderMainView();
    }
    function filterSongs(val) { searchTerm = val.toLowerCase(); renderMainView(); }
    function selectCategory(catId) { currentCategory = catId; renderMainView(); }
    function resetCategory() { currentCategory = null; renderMainView(); }

    function renderMainView() {
        const container = document.getElementById('listContainer'); container.innerHTML = '';
        if (currentMode === 'queue') { renderQueueList(container); return; }
        if (searchTerm) { renderSongList(container, allSongs.filter(s => (s.title + s.artist).toLowerCase().includes(searchTerm))); return; }
        if (currentCategory) {
            const backBtn = document.createElement('div'); backBtn.className = 'back-bar'; backBtn.innerHTML = `â¬… è¿”å›`; backBtn.onclick = resetCategory; container.appendChild(backBtn);
            renderSongList(container, allSongs.filter(s => s.tags.includes(currentCategory))); return;
        }
        renderCategories(container);
    }

    function renderCategories(container) {
        const grid = document.createElement('div'); grid.className = 'category-grid';
        categories.forEach(cat => {
            const card = document.createElement('div'); card.className = 'cat-card'; card.innerHTML = `<div class="cat-name">${cat.name}</div>`; card.onclick = () => selectCategory(cat.id); grid.appendChild(card);
        });
        container.appendChild(grid);
    }

    function renderSongList(container, songs) {
        if (songs.length === 0) { container.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">æ²’æœ‰æ‰¾åˆ°æ­Œæ›²</div>'; return; }
        songs.forEach(s => {
            const div = document.createElement('div'); div.className = 'song-row';
            div.innerHTML = `<div class="song-info"><span class="song-title">${s.title}</span><span class="song-artist">${s.artist}</span></div><button class="btn-add">+</button>`;
            div.onclick = () => handleAddClick(s); container.appendChild(div);
        });
    }

    function renderQueueList(container) {
        if(queue.length === 0) { container.innerHTML = '<div style="text-align:center; padding:30px; color:#999;">ç›®å‰æ²’æœ‰å¾…æ’­æ­Œæ›²</div>'; return; }
        queue.forEach((s, idx) => {
            const div = document.createElement('div'); div.className = 'song-row';
            div.innerHTML = `<div class="song-info"><span class="song-title">${idx + 1}. ${s.title}</span><span class="song-artist">${s.artist}</span></div><button class="btn" style="background:#eee; color:#333; font-size:0.8rem;" onclick="event.stopPropagation(); handleRemoveClick(${idx})">åˆªé™¤</button>`;
            container.appendChild(div);
        });
    }

    function updateStatus() {
        document.getElementById('queueBadge').innerText = queue.length;
        const hintEl = document.getElementById('nextSongHint');
        if (queue.length > 0) { hintEl.innerText = `ä¸‹ä¸€é¦–: ${queue[0].title}`; hintEl.style.display = 'inline'; } 
        else { hintEl.style.display = 'none'; }
        if (currentMode === 'queue') renderMainView();
    }

    function handleAddClick(song) { if (isClient) { sendCmd('add', song); switchTab('queue'); } else { addSong(song); } }
    function handleRemoveClick(idx) { if (isClient) { sendCmd('remove', idx); } else { removeSong(idx); } }
    
    function toggleControls(show) {
        const display = show ? 'block' : 'none';
        document.getElementById('hostPauseBtn').style.display = display;
        document.getElementById('hostCutBtn').style.display = display;
        const cinemaDisplay = show ? 'flex' : 'none';
        document.getElementById('cinemaPauseBtn').style.display = cinemaDisplay;
        document.getElementById('cinemaCutBtn').style.display = cinemaDisplay;
    }

    function resetTimer() { if (!document.body.classList.contains('cinema-mode') && !isClient) { clearTimeout(idleTimer); idleTimer = setTimeout(enterCinemaMode, IDLE_LIMIT); } }
    function enterCinemaMode() { if (!isClient) document.body.classList.add('cinema-mode'); }
    function wakeUp() { document.body.classList.remove('cinema-mode'); resetTimer(); }

    // --- PeerJS ---
    let peer, conn; let connections = [];
    function initHost() {
        if(typeof Peer === 'undefined') return;
        try {
            peer = new Peer();
            peer.on('open', id => {
                const url = `${location.href.split('?')[0]}?host=${id}`;
                document.getElementById('qrImg').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}`;
                // Host æº–å‚™å°±ç·’
            });
            peer.on('connection', c => {
                connections.push(c);
                c.on('open', () => { c.send({ type: 'syncSongs', data: allSongs }); c.send({ type: 'syncQueue', data: queue }); });
                c.on('data', data => {
                    if (data.action === 'add') addSong(data.payload);
                    if (data.action === 'remove') removeSong(data.payload);
                    if (data.action === 'cmd') { 
                        if (data.cmd === 'next') playNext(); 
                        if (data.cmd === 'pause') togglePlay(); 
                    }
                });
            });
        } catch(e) { console.error(e); }
    }
    function initClient(hostId) {
        if(typeof Peer === 'undefined') return;
        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect(hostId);
            document.getElementById('loadingText').innerText = "é€£ç·šæˆåŠŸï¼";
            conn.on('data', msg => {
                if (msg.type === 'syncSongs') { allSongs = msg.data; renderMainView(); }
                if (msg.type === 'syncQueue') { queue = msg.data; updateStatus(); }
            });
        });
    }
    function broadcastStatus() { if (isClient) return; connections.forEach(c => { if(c.open) c.send({ type: 'syncQueue', data: queue }); }); }
    function sendCmd(action, payload) { if(conn && conn.open) { if(action === 'add' || action === 'remove') { conn.send({ action: action, payload: payload }); } else { conn.send({ action: 'cmd', cmd: action }); } } }
    function toggleModal(show) { document.getElementById('qrModal').style.display = show ? 'flex' : 'none'; }
</script>
</body>
</html>